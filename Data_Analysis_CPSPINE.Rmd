---
title: "Data_Analysis_CPSPINE"
Author: "Katherine Dimitropoulou"
output: github_document
---

```{r setup}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(haven)
library(plotly)
library(viridis)
```

## Data import 

```{r, message=FALSE, warning=FALSE}
nsqipspineCP_1617 = read_csv("./nsqipspineCP_1617.csv")
```

note: Where variable type and length disagree, we get error message. Coercion occurs and outcome is all numeric/all character for any given column with longest length.

## Data simplification and coding

```{r, message=FALSE, warning=FALSE}
cp_spine_tidy = nsqipspineCP_1617 %>%
  mutate_if(is.numeric, ~replace(., . == -99, NA)) %>%
  mutate(
    age_years = age_days/365.25,
    height = height*2.54,
    weight = weight/2.2) %>%
  mutate(
    bmi = weight/((height/100)*(height/100)),
    asa_status = case_when(
      asaclas == "ASA 1 - No Disturb" ~ "1",
      asaclas == "ASA 2 - Mild Disturb" ~ "2",
      asaclas == "ASA 3 - Severe Disturb" ~ "3",
      asaclas == "ASA 4 - Life Threat" ~ "4",
      asaclas == "None assigned" ~ "NA"),
    home_discharge = case_when(
      dischdest == "Expired" ~ "FALSE",
      dischdest == "Facility Which was Home" ~ "TRUE",
      dischdest == "Home" ~ "TRUE",
      dischdest == "Rehab" ~ "FALSE",
      dischdest == "Separate Acute Care" ~ "FALSE",
      dischdest == "Skilled Care, Not Home" ~ "FALSE",
      dischdest == "Unknown" ~ "NA",
      dischdest == "Unskilled Facility Not Home" ~ "FALSE",
      dischdest == "NULL" ~ "NA"),
    level_13 = case_when(
      prncptx == "ARTHRODESIS, ANTERIOR, FOR SPINAL DEFORMITY, WITH OR WITHOUT CAST; 2 TO 3 VERTEBRAL SEGMENTS" ~ "FALSE",
      prncptx == "ARTHRODESIS, ANTERIOR, FOR SPINAL DEFORMITY, WITH OR WITHOUT CAST; 4 TO 7 VERTEBRAL SEGMENTS" ~ "FALSE",
      prncptx == "ARTHRODESIS, ANTERIOR, FOR SPINAL DEFORMITY, WITH OR WITHOUT CAST; 8 OR MORE VERTEBRAL SEGMENTS" ~ "FALSE",
      prncptx == "ARTHRODESIS, POSTERIOR, FOR SPINAL DEFORMITY, WITH OR WITHOUT CAST; UP TO 6 VERTEBRAL SEGMENTS" ~ "FALSE",
      prncptx == "ARTHRODESIS, POSTERIOR, FOR SPINAL DEFORMITY, WITH OR WITHOUT CAST; 7 TO 12 VERTEBRAL SEGMENTS" ~ "FALSE",
      prncptx == "ARTHRODESIS, POSTERIOR, FOR SPINAL DEFORMITY, WITH OR WITHOUT CAST; 13 OR MORE VERTEBRAL SEGMENTS" ~ "TRUE")) %>%
  filter(home_discharge != "NA") %>% 
  select(pufyear_x:ped_spn_post_neurodeftype, age_years, sex, height, weight, bmi, ethnicity_hispanic, race, asa_status, transt, ventilat, asthma, hxcld, oxygen_sup, crf, impcogstat, seizure, nutr_support, hemodisorder, level_13, optime, tothlos, d_opto_dis, death30yn, supinfec, wndinfd, orgspcssi, dehis, oupneumo, pulembol, renainsf, urninfec, cszre, neurodef, cdarrest, othbleed, bleed_ml_tot, othcdiff, othsysep, unplannedreadmission1, reoperation, dischdest, home_discharge)
```
## Analysis
We selected to do a stepwise logistic regression analysis, because it is recommended for small sample size, and it penalizes the models with lots of parameters and models with poor fit.
#Building the stepwise logistic regression analysis
```{r, message=FALSE, warning=FALSE}
cp_spine_tidy %>%
mutate(asa_level = ifelse(asa_status >2, 1, 0))
```
#Selection of candidate pre-operatice and peri-operative covariates for logistic regression
## We selected weight as the best predictor out of height, weight BMI
## Took out ethnicity and race as there is a 1/3 of teh data other so as predictor will not be meaningful.
```{r, message=FALSE, warning=FALSE}
model_covariates = cp_spine_tidy %>% 
  select(pufyear_x:ped_spn_post_neurodeftype, age_years, sex, height, weight, bmi, ethnicity_hispanic, race, asa_level, transt, ventilat, asthma, hxcld, oxygen_sup, crf, impcogstat, seizure, nutr_support, hemodisorder, level_13, home_discharge) %>% 
  na.omit(.)
```

```{r, message=FALSE, warning=FALSE}
just_covariates = model_covariates %>% select(home_discharge) %>% colnames(.)
```
# Create the full logistic model

```{r, message=FALSE, warning=FALSE}
full_fmla = as.formula(
  paste("home_discharge ~", paste(c(just_covariates), collapse = "+")))
```

# Models to help guide the automatic procedures
```{r, message=FALSE, warning=FALSE}
null = glm(home_discharge ~ 1, data = model_covariates, family = binomial())
full = glm(full_fmla, data = model_covariates, family = binomial())%>%
summary(step.model)
```
##Stepwise regression to select best subset
```{r, message=FALSE, warning=FALSE}
step.model = step(null, direction = 'both', scope = list(upper = full))
```
## Summary
```{r, message=FALSE, warning=FALSE}
summary(step.model)
```

# Race ethinity  missing (report how many here) a lot of them too difficult to interprete has a lot of missing  look at the note above and incorporate
```{r, message=FALSE, warning=FALSE}
glm(formula = home_discharge ~ age_years+ sex+ weight+ asa_status+transt, ventilat+ asthma + hxcld + oxygen_sup + crf + impcogstat + seizure+  nutr_support + hemodisorder, family = binomial(), data = model_covariates)