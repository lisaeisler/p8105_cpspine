---
title: "CPspine data analysis more extensive work not included in the report"
author: "Katherine Dimitropoulou"
output: github_document
---


```{r setup}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(haven)
library(viridis)
```


## Data import 

```{r, message=FALSE, warning=FALSE}
nsqipspineCP_1617 = read_csv("./nsqipspineCP_1617.csv")
```

note: Where variable type and length disagree, we get error message. Coercion occurs and outcome is all numeric/all character for any given column with longest length.

## Initial Data Cleaning & Selection of a subset of data to examine the purpose of the study.

```{r, message=FALSE, warning=FALSE}
cp_spine_tidy = nsqipspineCP_1617 %>%
  mutate_if(is.numeric, ~replace(., . == -99, NA)) %>%
  mutate(
    age_years = age_days/365.25,
    height = height*2.54,
    weight = weight/2.2) %>%
  mutate(
    bmi = weight/((height/100)*(height/100)),
    asa_status = case_when(
      asaclas == "ASA 1 - No Disturb" ~ "1",
      asaclas == "ASA 2 - Mild Disturb" ~ "2",
      asaclas == "ASA 3 - Severe Disturb" ~ "3",
      asaclas == "ASA 4 - Life Threat" ~ "4",
      asaclas == "None assigned" ~ "NA"),
    home_discharge = case_when(
      dischdest == "Expired" ~ "FALSE",
      dischdest == "Facility Which was Home" ~ "TRUE",
      dischdest == "Home" ~ "TRUE",
      dischdest == "Rehab" ~ "FALSE",
      dischdest == "Separate Acute Care" ~ "FALSE",
      dischdest == "Skilled Care, Not Home" ~ "FALSE",
      dischdest == "Unknown" ~ "NA",
      dischdest == "Unskilled Facility Not Home" ~ "FALSE",
      dischdest == "NULL" ~ "NA"),
    level_13 = case_when(
      prncptx == "ARTHRODESIS, ANTERIOR, FOR SPINAL DEFORMITY, WITH OR WITHOUT CAST; 2 TO 3 VERTEBRAL SEGMENTS" ~ "FALSE",
      prncptx == "ARTHRODESIS, ANTERIOR, FOR SPINAL DEFORMITY, WITH OR WITHOUT CAST; 4 TO 7 VERTEBRAL SEGMENTS" ~ "FALSE",
      prncptx == "ARTHRODESIS, ANTERIOR, FOR SPINAL DEFORMITY, WITH OR WITHOUT CAST; 8 OR MORE VERTEBRAL SEGMENTS" ~ "FALSE",
      prncptx == "ARTHRODESIS, POSTERIOR, FOR SPINAL DEFORMITY, WITH OR WITHOUT CAST; UP TO 6 VERTEBRAL SEGMENTS" ~ "FALSE",
      prncptx == "ARTHRODESIS, POSTERIOR, FOR SPINAL DEFORMITY, WITH OR WITHOUT CAST; 7 TO 12 VERTEBRAL SEGMENTS" ~ "FALSE",
      prncptx == "ARTHRODESIS, POSTERIOR, FOR SPINAL DEFORMITY, WITH OR WITHOUT CAST; 13 OR MORE VERTEBRAL SEGMENTS" ~ "TRUE"))  %>% 
  filter(home_discharge != "NA") %>% 
  select(pufyear_x:ped_spn_post_neurodeftype, age_years, sex, height, weight, bmi, ethnicity_hispanic, race, asa_status, transt, ventilat, asthma, hxcld, oxygen_sup, crf, impcogstat, seizure, nutr_support, hemodisorder, level_13, optime, tothlos, d_opto_dis, death30yn, supinfec, wndinfd, orgspcssi, dehis, oupneumo, pulembol, renainsf, urninfec, cszre, neurodef, cdarrest, othbleed, bleed_ml_tot, othcdiff, othsysep, unplannedreadmission1, reoperation, dischdest, home_discharge)
```
## Analysis and models
Our goal is to develop a model,in which we can use important pre-operative factors to predict the patient's discharge at home. 
The initial set of pre-operative variables is:
pufyear_x:ped_spn_post_neurodeftype, 
age_years= Age in Years (continues var.)
sex=Gender (binary var.)
height= Height (inch) (continues var.)
weight= Weight(lbs) (continues var.)
bmi= BMI (continues var.)
ethnicity_hispanic=Ethnicity (Categorical var.)
race= Race (Categorical var.)
asa_status= ASA Classification (Categorical var.)
transt= Transfer Status (Admitted from Home or ER, or Rehab Care facility, etc.) (Categorical var.)
ventilat= Ventilator Dependence (binary var.)
asthma=Asthma (binary var.)
hxcld= Bronchopulmonary Dysplasia/Chronic Lung Disease (binary var.)
oxygen_sup= Oxygen Support (binary var.)
crf= Cardiac Risk Factors (Categorical var.)
impcogstat= Developmental Delay/Impaired Cognitive Status (binary var.)
seizure= Seizure Disorder (binary var.)
nutr_support=Nutritional Support  (binary var.)
hemodisorder=Hematologic Disorder (binary var.)
level_13= Fusion of 13 or more vertebral segments (binary var.)

## Selection of predictors to include in the model

* From the series of variables  weight, height, and BMI (all three highly related) we selected based on literature review bmi to be included in the model.
* From our initial data visualization, ethnicity has large number of patients who self-identified as "Other", it is unclear how to use other to create preditions thus the ethnicity variable was eliminated. 
* We examined the var "Transt" which indicates where the patient was before coming to surgery. The variable was turned in to binary "transt1", as the sample size does not allow for multiple categorical variables.  This below does not run.
transt1 = case_when(
      transt == "Chronic care, Rehab,Intermediate Care;Spinal Cord" ~ "FALSE",
      transt == "Transferred from outside hospital (NICU, PICU, Inpatient on General floor, Adult" ~"FALSE",
      transt == "other" ~ "FALSE",
      transt == "Admitted from home;clinic;doctor's office" ~ "TRUE",
      transt == "Admitted through ER, including outside ER with direct hospital admission" ~ "TRUE"),
  transt1=as.factor(transt1),
* From the literature we know that cognitive ability can be a confound to the severity of Neuromusculoskeletal disorder and does not relate to medical complications. Thus, we eliminated from  the model "impcogstat".
* Also recoded cardiac risk factor (crf) as a binary variable, again because of the small sample size.NEED TO TRANSFORM TO BINARY???
* We will examine a total of 13 (will be 15 after we fix the two above) variables for the full model. Before entering the full model we will use cross tabs to see if there are any  cells with 0 (n=0).
```{r, message=FALSE, warning=FALSE}
model_data = cp_spine_tidy %>% 
  mutate(
    sex1=case_when(
    sex=="Male"~"0",
    sex=="Female"~"1"),
    sex1=as.factor(sex1),
    race = case_when(
    race == "American Indian,Alaskan Native" ~ "1",
    race == "Asian" ~ "2",
    race == "Black or African American" ~ "3",
    race == "Native Hawaiian or Other Pacific Islander" ~ "4",
    race == "White" ~ "5",
    race == "Unknown Not Reported" ~ "6"),
    race1=as.factor(race),
    asa_level = ifelse(asa_status >2, 1, 0),
    asa_level=as.factor(asa_level),
    ventilat1=case_when(
    ventilat=="No"~"0",
    ventilat=="Yes"~"1"),
    ventilat1=as.factor(ventilat1), 
  asthma1=case_when(
    asthma=="No"~"0",
    asthma=="Yes"~"1"),
  asthma1=as.factor(asthma1),
  hxcld1=case_when(
    hxcld=="No"~"0",
    hxcld=="Yes"~"1"),
  hxcld1=as.factor(hxcld1),
  oxygen_sup1=case_when(
    oxygen_sup=="No"~"0",
    oxygen_sup=="Yes"~"1"),
  oxygen_sup1=as.factor(oxygen_sup1),
  seizure1=case_when(
    seizure=="No"~"0",
    seizure=="Yes"~"1"),
  seizure1=as.factor(seizure1),
  nutr_support1=case_when(
    nutr_support=="No"~"0",
    nutr_support=="Yes"~"1"),
  nutr_support1=as.factor(nutr_support1),
hemodisorder1=case_when(
    hemodisorder=="No"~"0",
    hemodisorder=="Yes"~"1"),
  hemodisorder1=as.factor(hemodisorder1),
 level_13=as.factor(level_13),
 home_discharge1=case_when(
   home_discharge=="TRUE"~"1",
   home_discharge=="FALSE"~"0"),
home_discharge1=as.factor(home_discharge1), 
  crf1 = case_when(
      crf == "Major cardiac risk factors" ~ "FALSE",
      crf == "Severe cardiac risk factors" ~"FALSE",
      crf == "Minor cardiac risk factors" ~ "TRUE",
      crf == "No cardiac risk factors" ~ "TRUE"), 
  crf1=as.factor(crf1),
  transt1 = case_when(
      transt == "Chronic care Rehab/Intermediate Care/Spinal Cord" ~ "FALSE",
      transt == "Transferred from outside hospital (NICU, PICU, Inpatient on General floor, Adult" ~"FALSE",
      transt == "other" ~ "FALSE",
      transt == "Admitted from home/clinic/doctor's office" ~ "TRUE",
      transt == "Admitted through ER, including outside ER with direct hospital admission" ~ "TRUE"),
  transt1=as.factor(transt1))%>%
  select(age_years, bmi, weight, sex1, transt1, crf1, race1, asa_level, ventilat1, asthma1, hxcld1, oxygen_sup1, seizure1, nutr_support1, hemodisorder1, level_13, home_discharge1) %>%
  na.omit(model_data)
```
Total graph of all predictors to the outcome
     
1. Overall quick descriptives for the data entered in the model
```{r, message=FALSE, warning=FALSE}
summary(model_data)
```
2. Two-way contingency tables of categorical outcome and predictors we want
## to make sure there are no cells with n=0
```{r, message=FALSE, warning=FALSE}
xtabs(~ home_discharge1+ sex1, data = model_data)
```